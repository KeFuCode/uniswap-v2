# Uniswap-V2

## IDEAs

1. æ²¡æœ‰æµåŠ¨æ€§å°±æ— æ³•è¿›è¡Œäº¤æ˜“ã€‚
2. å›¾ä¹¦é¦†åˆçº¦æ˜¯ä¸€ä¸ªå›¾ä¹¦é¦†ï¼ˆä¸æ˜¯æ•…æ„çš„ğŸ˜¬ï¼‰ã€‚(è°éŸ³æ¢—)
3. ä»·æ ¼æ˜¯ä»€ä¹ˆï¼Ÿå®ƒæ˜¯ä½ ç”¨ä¸€å•ä½çš„å¦ä¸€æ ·ä¸œè¥¿äº¤æ¢å¾—åˆ°çš„ä¸€æ ·ä¸œè¥¿çš„æ•°é‡ã€‚åœ¨äº¤æ˜“ä¸­ï¼Œä»·æ ¼åœ¨æŸç§ç¨‹åº¦ä¸Šæ˜¯ä¸€ä¸ªä¸­é—´å®ä½“ï¼šé‡è¦çš„æ˜¯ä½ æ‹¥æœ‰çš„ä»£å¸æ•°é‡å’Œä½ å¾—åˆ°çš„ä»£å¸æ•°é‡ã€‚åœ¨ä¸€ä¸ªä¸æ–­è¿›è¡Œäº§å“äº¤æ¢çš„è¿‡ç¨‹ä¸­ï¼Œä»·æ ¼åªæ˜¯å‚¨å¤‡ä¹‹é—´çš„å…³ç³»ã€‚

## Q&A

### Section 1

Qï¼šUniswap V2 çš„æ ¸å¿ƒåˆçº¦æ˜¯ä»€ä¹ˆï¼ŸUniswapV2Pair åˆçº¦ä¸ Exchange åˆçº¦çš„åŒºåˆ«æ˜¯ä»€ä¹ˆï¼Ÿ  
Aï¼š1.Uniswap V2 çš„æ ¸å¿ƒåˆçº¦æ˜¯UniswapV2Pairã€‚"Pair"å’Œ"Pool"æ˜¯å¯ä»¥äº’æ¢ä½¿ç”¨çš„æœ¯è¯­ï¼Œå®ƒä»¬æŒ‡çš„æ˜¯åŒä¸€ä¸ªåˆçº¦ - UniswapV2Pair åˆçº¦ã€‚è¯¥åˆçº¦çš„ä¸»è¦ç›®çš„æ˜¯æ¥æ”¶ç”¨æˆ·çš„ token ï¼Œå¹¶ä½¿ç”¨ç´¯ç§¯çš„ token å‚¨å¤‡è¿›è¡Œäº¤æ¢ã€‚è¿™å°±æ˜¯ä¸ºä»€ä¹ˆå®ƒè¢«ç§°ä¸º Pool åˆçº¦ã€‚æ¯ä¸ª UniswapV2Pair åˆçº¦åªèƒ½æ±‡é›†ä¸€å¯¹ token ï¼Œå¹¶ä¸”åªå…è®¸åœ¨è¿™ä¸¤ç§ token ä¹‹é—´è¿›è¡Œäº¤æ¢ - è¿™å°±æ˜¯ä¸ºä»€ä¹ˆå®ƒè¢«ç§°ä¸º"pair"çš„åŸå› ã€‚2. Exchange åˆçº¦æ±‡é›†çš„ä¸€ç§ token å’Œ etherï¼ŒUniswapV2Pair æ±‡é›†çš„æ˜¯ä¸€å¯¹ tokenã€‚

Qï¼šUniswap V2 çš„ Core åˆçº¦éƒ¨åˆ†ä¸»è¦æ˜¯ä»€ä¹ˆå†…å®¹ï¼Ÿ  
Aï¼š1.UniswapV2ERC20 ï¼Œ ä¸€ä¸ªæ‰©å±•çš„ERC20å®ç°ï¼Œç”¨äºLPä»£å¸ã€‚å®ƒè¿˜å®ç°äº†EIP-2612ä»¥æ”¯æŒé“¾ä¸‹è½¬è´¦çš„æ‰¹å‡†ã€‚2.UniswapV2Factory - ç±»ä¼¼äºV1ï¼Œè¿™æ˜¯ä¸€ä¸ªå·¥å‚åˆçº¦ï¼Œç”¨äºåˆ›å»ºé…å¯¹åˆçº¦å¹¶ä½œä¸ºå…¶æ³¨å†Œè¡¨ã€‚æ³¨å†Œè¡¨ä½¿ç”¨ create2 æ¥ç”Ÿæˆé…å¯¹åœ°å€ - æˆ‘ä»¬å°†è¯¦ç»†äº†è§£å…¶å·¥ä½œåŸç†ã€‚3.UniswapV2Pair - ä¸»è¦åˆçº¦è´Ÿè´£æ ¸å¿ƒé€»è¾‘ã€‚å€¼å¾—æ³¨æ„çš„æ˜¯ï¼Œå·¥å‚åªå…è®¸åˆ›å»ºå”¯ä¸€çš„äº¤æ˜“å¯¹ï¼Œä»¥é¿å…æµåŠ¨æ€§çš„ç¨€é‡Šã€‚

Qï¼šUniswap V2 çš„ è¾…åŠ©åˆçº¦éƒ¨åˆ†ä¸»è¦æ˜¯ä»€ä¹ˆå†…å®¹ï¼Ÿ  
Aï¼šperiphery å­˜å‚¨åº“åŒ…å«å¤šä¸ªåˆçº¦ï¼Œä½¿å¾—ä½¿ç”¨Uniswapå˜å¾—æ›´åŠ ä¾¿æ·ã€‚å…¶ä¸­ä¹‹ä¸€æ˜¯ UniswapV2Router ï¼Œå®ƒæ˜¯Uniswapç”¨æˆ·ç•Œé¢ä»¥åŠå…¶ä»–åŸºäºUniswapçš„ç½‘ç»œå’Œå»ä¸­å¿ƒåŒ–åº”ç”¨çš„ä¸»è¦å…¥å£ã€‚è¯¥åˆçº¦çš„æ¥å£ä¸Uniswap V1ä¸­çš„äº¤æ˜“åˆçº¦éå¸¸ç›¸ä¼¼ã€‚å¦ä¸€ä¸ªé‡è¦çš„åˆçº¦æ˜¯ UniswapV2Library ï¼Œå®ƒæ˜¯ä¸€ç»„å®ç°é‡è¦è®¡ç®—çš„è¾…åŠ©å‡½æ•°ã€‚

Qï¼šUniswap V2 ä¸ºä»€ä¹ˆè®¾ç½® reserve0 å’Œ reserve1 è·Ÿè¸ªæ± å­çš„å‚¨å¤‡ï¼Ÿ  
Aï¼šä¸»è¦åŸå› æ˜¯ä»…ä¾èµ–ERC20ä½™é¢ä¼šå¯¼è‡´ä»·æ ¼æ“çºµçš„å¯èƒ½æ€§ï¼šæƒ³è±¡ä¸€ä¸‹ï¼Œæœ‰äººå‘ä¸€ä¸ªæ± å­å‘é€å¤§é‡ä»£å¸ï¼Œè¿›è¡Œæœ‰åˆ©çš„äº¤æ¢ï¼Œæœ€åå°†å…¶å…‘ç°ã€‚ä¸ºäº†é¿å…è¿™ç§æƒ…å†µï¼Œæˆ‘ä»¬éœ€è¦åœ¨æˆ‘ä»¬è¿™ä¸€æ–¹è¿½è¸ªæ± å­çš„å‚¨å¤‡ï¼Œå¹¶ä¸”éœ€è¦æ§åˆ¶å®ƒä»¬ä½•æ—¶æ›´æ–°ã€‚
é—®GPTï¼šä¸¾ä¾‹å­å¸®åŠ©ç†è§£å¦‚ä½•è¿›è¡Œä»·æ ¼æ“çºµå¥—åˆ©ï¼Ÿ

Qï¼šå¯¹äºåˆå§‹çš„LPé‡‘é¢ï¼ŒUniswap V2 ä¸ºä»€ä¹ˆæœ€ç»ˆé‡‡ç”¨äº†å­˜å…¥é‡‘é¢çš„å‡ ä½•å¹³å‡å€¼ `Math.sqrt(amount0 * amount1)` ï¼Ÿ  
Aï¼šè¿™ä¸ªå†³å®šçš„ä¸»è¦å¥½å¤„æ˜¯ï¼Œè¿™æ ·çš„å…¬å¼ç¡®ä¿äº†åˆå§‹æµåŠ¨æ€§æ¯”ç‡ä¸ä¼šå½±å“èµ„é‡‘æ± ä»½é¢çš„ä»·å€¼ã€‚ï¼ˆå‡è®¾Aliceå’ŒBobéƒ½æƒ³åœ¨Uniswapåˆ›å»ºä¸€ä¸ªæ–°çš„æµåŠ¨æ€§æ± ã€‚Aliceé€‰æ‹©å°†100ä¸ªtoken0å’Œ200ä¸ªtoken1å­˜å…¥ï¼ŒBobé€‰æ‹©å°†200ä¸ªtoken0å’Œ400ä¸ªtoken1å­˜å…¥ã€‚å°½ç®¡BobæŠ•å…¥çš„é‡‘é¢æ˜¯Aliceçš„ä¸¤å€ï¼Œä½†æ˜¯ä»–ä»¬é€‰æ‹©çš„token0åˆ°token1çš„æ¯”ç‡æ˜¯ç›¸åŒçš„ï¼Œæ‰€ä»¥æ— è®ºAliceè¿˜æ˜¯Bobï¼Œä»–ä»¬è·å¾—çš„æµåŠ¨æ€§ä»£å¸çš„æ•°é‡æ˜¯ç”±å­˜å…¥çš„token0å’Œtoken1çš„å‡ ä½•å¹³å‡æ•°å†³å®šçš„ã€‚å¦‚æœAliceå’ŒBobéƒ½åœ¨ç›¸åŒçš„ä»·æ ¼ï¼ˆtoken0/token1çš„æ¯”ç‡ï¼‰ä¸‹å‘æ± ä¸­æ·»åŠ æµåŠ¨æ€§ï¼Œé‚£ä¹ˆä»–ä»¬å¾—åˆ°çš„æ¯ä¸ªæµåŠ¨æ€§ä»£å¸ä»£è¡¨çš„æ± ä¸­ä»½é¢çš„ä»·å€¼å°†ä¼šæ˜¯ç›¸åŒçš„ã€‚æ— è®ºä»–ä»¬å„è‡ªæŠ•å…¥äº†å¤šå°‘èµ„é‡‘ï¼Œåªè¦ä»–ä»¬çš„æŠ•å…¥æ¯”ç‡ç›¸åŒï¼Œä»–ä»¬çš„æŠ•å…¥éƒ½å°†æœ‰ç›¸åŒçš„ä»·å€¼ã€‚è¿™å°±æ˜¯ä¸ºä»€ä¹ˆæˆ‘ä»¬è¯´è¿™ç§è®¾è®¡å¯ä»¥ç¡®ä¿åˆå§‹æµåŠ¨æ€§æ¯”ç‡ä¸ä¼šå½±å“èµ„é‡‘æ± ä»½é¢çš„ä»·å€¼ã€‚ï¼‰

Qï¼šuniswap åœ¨ä½¿ç”¨ `liquidity = Math.sqrt(amount0 * amount1) - MINIMUM_LIQUIDITY` è®¡ç®—æµåŠ¨æ€§æ—¶ï¼Œä¸ºä»€ä¹ˆé€‰æ‹©å–è¾ƒå°çš„é‚£ä¸ª?  
Aï¼š1.åœ¨è¿™æ®µä»£ç ä¸­ï¼ŒUniswapæ˜¯åœ¨è®¡ç®—ç”¨æˆ·æä¾›æµåŠ¨æ€§åï¼Œåº”è¯¥é“¸é€ å¤šå°‘æµåŠ¨æ€§ä»£å¸ï¼ˆliquidityï¼‰ã€‚è¿™ä¸ªæ•°é‡åº”è¯¥ä¸ç”¨æˆ·æä¾›çš„èµ„é‡‘å’Œæ± å­ä¸­å·²æœ‰çš„èµ„é‡‘ï¼ˆå‚¨å¤‡ï¼‰æˆæ¯”ä¾‹ã€‚ä¹Ÿå°±æ˜¯è¯´ï¼Œå¦‚æœç”¨æˆ·æŠ•å…¥çš„èµ„é‡‘å äº†æ± å­æ€»èµ„é‡‘çš„1%ï¼Œé‚£ä¹ˆä»–åº”è¯¥å¾—åˆ°1%çš„æµåŠ¨æ€§ä»£å¸ã€‚2.å­˜æ¬¾é‡‘é¢ä¸å‚¨å¤‡æ¯”ç‡è¶Šæ¥è¿‘ï¼Œå·®å¼‚å°±è¶Šå°ã€‚å› æ­¤ï¼Œå¦‚æœå­˜æ¬¾é‡‘é¢çš„æ¯”ç‡ä¸åŒï¼ŒLPé‡‘é¢ä¹Ÿä¼šä¸åŒï¼Œå…¶ä¸­ä¸€ä¸ªä¼šæ¯”å¦ä¸€ä¸ªå¤§ã€‚å¦‚æœæˆ‘ä»¬é€‰æ‹©è¾ƒå¤§çš„é‚£ä¸ªï¼Œé‚£ä¹ˆæˆ‘ä»¬å°†é€šè¿‡æä¾›æµåŠ¨æ€§æ¥æ¿€åŠ±ä»·æ ¼å˜åŠ¨ï¼Œè¿™å°†å¯¼è‡´ä»·æ ¼æ“çºµã€‚å¦‚æœæˆ‘ä»¬é€‰æ‹©è¾ƒå°çš„é‚£ä¸ªï¼Œæˆ‘ä»¬å°†æƒ©ç½šä¸å¹³è¡¡æµåŠ¨æ€§çš„å­˜æ¬¾ï¼ˆæµåŠ¨æ€§æä¾›è€…å°†è·å¾—è¾ƒå°‘çš„LPä»£å¸ï¼‰ã€‚å¾ˆæ˜æ˜¾ï¼Œé€‰æ‹©è¾ƒå°çš„æ•°å­—æ›´æœ‰åˆ©ï¼Œè¿™å°±æ˜¯Uniswapæ­£åœ¨åšçš„ã€‚ï¼ˆè¿™æ˜¯å› ä¸ºæˆ‘ä»¬å¸Œæœ›æ¿€åŠ±ç”¨æˆ·æä¾›å¹³è¡¡çš„æµåŠ¨æ€§ã€‚ä¹Ÿå°±æ˜¯è¯´ï¼Œç”¨æˆ·æä¾›çš„ä¸¤ç§ä»£å¸çš„æ•°é‡åº”è¯¥ä¸æ± å­ä¸­ä¸¤ç§ä»£å¸çš„æ•°é‡ä¿æŒç›¸åŒçš„æ¯”ä¾‹ã€‚å¦‚æœç”¨æˆ·æä¾›çš„ä¸¤ç§ä»£å¸çš„æ¯”ä¾‹ä¸æ± å­çš„æ¯”ä¾‹ä¸åŒï¼Œé‚£ä¹ˆä»–å°†ä¼šå¾—åˆ°è¾ƒå°‘çš„æµåŠ¨æ€§ä»£å¸ã€‚è¿™ç§è®¾è®¡å¯ä»¥é˜²æ­¢ç”¨æˆ·é€šè¿‡å¤§é‡æä¾›ä¸€ç§ä»£å¸æ¥æ“çºµä»·æ ¼ã€‚ï¼‰3.å‡è®¾æ± å­ä¸­æœ‰100ä¸ªä»£å¸Aå’Œ200ä¸ªä»£å¸Bï¼Œå¦‚æœç”¨æˆ·æä¾›50ä¸ªä»£å¸Aå’Œ50ä¸ªä»£å¸Bï¼Œé‚£ä¹ˆä»–æä¾›çš„ä»£å¸Aå’Œä»£å¸Bçš„æ¯”ä¾‹ï¼ˆ1:1ï¼‰å°±ä¸æ± å­ä¸­çš„æ¯”ä¾‹ï¼ˆ1:2ï¼‰ä¸åŒã€‚åœ¨è¿™ç§æƒ…å†µä¸‹ï¼Œç”¨æˆ·æä¾›çš„ä»£å¸Aç›¸å¯¹è¿‡å¤šï¼Œæ‰€ä»¥ä»–å°†ä¼šå¾—åˆ°è¾ƒå°‘çš„æµåŠ¨æ€§ä»£å¸ã€‚

Qï¼šå¯¹äº `uint256 public totalSupply` ï¼Œåœ¨ UniswapV2Pair ä¸­ï¼Œç›´æ¥ä½¿ç”¨ `totalSupply` ï¼Œåœ¨ UniswapV2PairTest ä¸­ï¼Œä¸ºä»€ä¹ˆéœ€è¦ä½¿ç”¨ `totalSupply()` ï¼Ÿ  
Aï¼š1.åœ¨ Solidity ä¸­å£°æ˜ä¸º public çš„çŠ¶æ€å˜é‡ï¼Œä¸èƒ½ç›´æ¥ä»å¤–éƒ¨è®¿é—®å®ƒä»¬çš„å€¼ï¼Œå› ä¸ºå¤–éƒ¨è°ƒç”¨å¿…é¡»é€šè¿‡ç½‘ç»œå’ŒEthereumè™šæ‹Ÿæœº(EVM)è¿›è¡Œã€‚2.å½“ä½ ä»å¦ä¸€ä¸ªåˆçº¦æˆ–ä»å¤–éƒ¨è®¿é—®ä¸€ä¸ªçŠ¶æ€å˜é‡æ—¶ï¼Œå¿…é¡»é€šè¿‡å…¶å¯¹åº”çš„getterå‡½æ•°æ¥è¿›è¡Œã€‚Solidityä¸ºæ¯ä¸ªpublicçŠ¶æ€å˜é‡è‡ªåŠ¨åˆ›å»ºä¸€ä¸ªå…¬å…±getterå‡½æ•°ã€‚3.å½“ä½ åœ¨åŒä¸€ä¸ªåˆçº¦å†…éƒ¨è®¿é—®ä¸€ä¸ªçŠ¶æ€å˜é‡æ—¶ï¼Œå¯ä»¥ç›´æ¥è®¿é—®å…¶å€¼ï¼Œå› ä¸ºè¿™ä¸æ¶‰åŠä»»ä½•ç½‘ç»œé€šä¿¡æˆ–EVMçš„æ“ä½œã€‚

### Section 2

Qï¼šä¸ºä»€ä¹ˆ `swap(uint256 amount0Out, uint256 amount1Out, address to)` ä¸­è®¾ç½® amount0Out å’Œ amount1Out ä¸¤ä¸ªå…¥å‚ï¼Ÿ  
Aï¼šè¯¥å‡½æ•°æ¥å—ä¸¤ä¸ªè¾“å‡ºé‡‘é¢ï¼Œæ¯ä¸ªä»£å¸å¯¹åº”ä¸€ä¸ªé‡‘é¢ã€‚è¿™äº›é‡‘é¢æ˜¯è°ƒç”¨è€…æƒ³è¦ç”¨ä»–ä»¬çš„ä»£å¸äº¤æ¢å¾—åˆ°çš„ã€‚ä¸ºä»€ä¹ˆè¦è¿™æ ·åšå‘¢ï¼Ÿå› ä¸ºæˆ‘ä»¬ç”šè‡³ä¸æƒ³å¼ºåˆ¶äº¤æ¢çš„æ–¹å‘ï¼šè°ƒç”¨è€…å¯ä»¥æŒ‡å®šå…¶ä¸­ä¸€ä¸ªé‡‘é¢æˆ–ä¸¤ä¸ªé‡‘é¢ï¼Œæˆ‘ä»¬å°†åªæ‰§è¡Œå¿…è¦çš„æ£€æŸ¥ã€‚

Qï¼šåœ¨uniswap v2ä¸­ï¼Œä¸ºä»€ä¹ˆä¸ä½¿ç”¨ERC20æ¥å£çš„ `token0.transfer(to, amount0Out)` ï¼Œè€Œä½¿ç”¨äº† `_safeTransfer(token0, to, amount0Out)` ï¼Ÿ  
```solidity
function _safeTransfer(
    address token,
    address to,
    uint256 amount
) private {
    (bool success, bytes memory data) = token.call(abi.encodeWithSignature("transfer(address,uint256)", to, amount));
    // require(success && (data.length == 0 || abi.decode(data, (bool))), "TRANSFER_FAILED");
    if (!success || (data.length != 0 && !abi.decode(data, (bool)))) revert TransferFailed();
}
```  
Aï¼š1.åœ¨é…å¯¹åˆçº¦ä¸­ï¼Œåœ¨è¿›è¡Œä»£å¸è½¬è´¦æ—¶ï¼Œæˆ‘ä»¬æ€»æ˜¯å¸Œæœ›ç¡®ä¿è½¬è´¦æˆåŠŸã€‚æ ¹æ®ERC20æ ‡å‡†ï¼Œ transfer æ–¹æ³•å¿…é¡»è¿”å›ä¸€ä¸ªå¸ƒå°”å€¼ï¼š true è¡¨ç¤ºæˆåŠŸï¼Œ fails è¡¨ç¤ºå¤±è´¥ã€‚å¤§å¤šæ•°ä»£å¸éƒ½æ­£ç¡®å®ç°äº†è¿™ä¸€ç‚¹ï¼Œä½†æœ‰äº›ä»£å¸æ²¡æœ‰â€”â€”å®ƒä»¬åªæ˜¯è¿”å›äº†ç©ºå€¼ã€‚å½“ç„¶ï¼Œæˆ‘ä»¬æ— æ³•æ£€æŸ¥ä»£å¸åˆçº¦çš„å®ç°ï¼Œå¹¶ä¸èƒ½ç¡®å®šä»£å¸è½¬è´¦æ˜¯å¦ç¡®å®å®Œæˆï¼Œä½†è‡³å°‘æˆ‘ä»¬å¯ä»¥æ£€æŸ¥è½¬è´¦ç»“æœã€‚å¦‚æœè½¬è´¦å¤±è´¥ï¼Œæˆ‘ä»¬ä¸å¸Œæœ›ç»§ç»­è¿›è¡Œã€‚2. call -- è¿™æ˜¯ä¸€ä¸ªä½çº§å‡½æ•°ï¼Œå®ƒå¯ä»¥è®©æˆ‘ä»¬å¯¹åˆçº¦è°ƒç”¨æœ‰æ›´ç²¾ç»†çš„æ§åˆ¶ã€‚åœ¨è¿™ä¸ªç‰¹å®šçš„æƒ…å†µä¸‹ï¼Œå®ƒå…è®¸æˆ‘ä»¬æ— è®º transfer æ–¹æ³•æ˜¯å¦è¿”å›ç»“æœï¼Œéƒ½èƒ½å¾—åˆ°ä¸€ä¸ªè½¬è´¦çš„ç»“æœã€‚

Qï¼šåœ¨ `swap(uint256 amount0Out, uint256 amount1Out, address to)` ä¸­ï¼Œè½¬è´¦å‰ä¸ºä»€ä¹ˆè¦è¿›è¡Œæ¡ä»¶æ£€æŸ¥ï¼Ÿ  
```solidity
if (amount0Out > 0) _safeTransfer(token0, to, amount0Out);
if (amount1Out > 0) _safeTransfer(token1, to, amount1Out);
```  
Aï¼š1.amount0Outå’Œamount1Outæ˜¯å‡½æ•°å‚æ•°ï¼Œè¡¨ç¤ºä»èµ„é‡‘æ± ä¸­å–å‡ºçš„ä¸¤ç§ä»£å¸çš„æ•°é‡ã€‚2.æ£€æŸ¥amount0Out > 0å’Œamount1Out > 0æ˜¯ä¸ºäº†é¿å…æ— æ„ä¹‰çš„è½¬è´¦ã€‚å¦‚æœè¦è½¬å‡ºçš„ä»£å¸æ•°é‡ä¸º0ï¼Œé‚£ä¹ˆè°ƒç”¨_safeTransferå‡½æ•°å°±æ²¡æœ‰æ„ä¹‰ï¼Œåªä¼šæ¶ˆè€—æ›´å¤šçš„gasã€‚3.å¯¹äºæŸäº›ä»£å¸åˆçº¦æ¥è¯´ï¼Œå°è¯•è½¬ç§»0ä¸ªä»£å¸å¯èƒ½ä¼šå¼•å‘é”™è¯¯ã€‚æ‰€ä»¥è¿™ä¸ªæ£€æŸ¥å¯ä»¥é¿å…ä¸å¿…è¦çš„é—®é¢˜å’Œè´¹ç”¨ã€‚

Qï¼šä»€ä¹ˆæ˜¯é¢„è¨€æœºï¼Ÿ  
Aï¼š1.å°†åŒºå—é“¾ä¸ç¦»é“¾æœåŠ¡è¿æ¥èµ·æ¥ï¼Œä»¥ä¾¿ä»æ™ºèƒ½åˆçº¦ä¸­æŸ¥è¯¢ç°å®ä¸–ç•Œçš„æ•°æ®ï¼Œå·²ç»å­˜åœ¨äº†ç›¸å½“é•¿çš„æ—¶é—´ã€‚Chainlinkæ˜¯æœ€å¤§çš„é¢„è¨€æœºç½‘ç»œä¹‹ä¸€ï¼Œå®ƒäº2017å¹´åˆ›å»ºï¼Œå¦‚ä»Šå·²æˆä¸ºè®¸å¤šDeFiåº”ç”¨çš„å…³é”®ç»„æˆéƒ¨åˆ†ã€‚2.Uniswapæ˜¯ä¸€ä¸ªé“¾ä¸Šåº”ç”¨ï¼ŒåŒæ—¶ä¹Ÿå¯ä»¥ä½œä¸ºä¸€ä¸ªé¢„è¨€æœºã€‚æ¯ä¸ªç»å¸¸è¢«äº¤æ˜“è€…ä½¿ç”¨çš„Uniswapäº¤æ˜“å¯¹åˆçº¦ä¹Ÿå¸å¼•äº†å¥—åˆ©è€…ï¼Œä»–ä»¬é€šè¿‡å‡å°äº¤æ˜“æ‰€ä¹‹é—´çš„ä»·æ ¼å·®å¼‚æ¥èµšé’±ã€‚å¥—åˆ©è€…ä½¿å¾—Uniswapçš„ä»·æ ¼å°½å¯èƒ½æ¥è¿‘ä¸­å¿ƒåŒ–äº¤æ˜“æ‰€çš„ä»·æ ¼ï¼Œè¿™ä¹Ÿå¯ä»¥çœ‹ä½œæ˜¯å°†ä¸­å¿ƒåŒ–äº¤æ˜“æ‰€çš„ä»·æ ¼è¾“å…¥åˆ°åŒºå—é“¾ä¸­ã€‚

Qï¼šUniswap V2ä¸­å¦‚ä½•å®ç°é¢„è¨€æœºï¼Ÿ  
Aï¼š1.åœ¨Uniswap V2ä¸­ï¼Œä»·æ ¼é¢„è¨€æœºæä¾›çš„ä»·æ ¼ç±»å‹è¢«ç§°ä¸ºæ—¶é—´åŠ æƒå¹³å‡ä»·æ ¼ï¼Œæˆ–è€…ç®€ç§°ä¸ºTWAPã€‚å®ƒåŸºæœ¬ä¸Šå…è®¸åœ¨ä¸¤ä¸ªæ—¶é—´ç‚¹ä¹‹é—´è·å¾—å¹³å‡ä»·æ ¼ã€‚ä¸ºäº†å®ç°è¿™ä¸€ç‚¹ï¼Œåˆçº¦ä¼šå­˜å‚¨ç´¯ç§¯ä»·æ ¼ï¼šåœ¨æ¯æ¬¡äº¤æ¢ä¹‹å‰ï¼Œå®ƒä¼šè®¡ç®—å½“å‰çš„è¾¹é™…ä»·æ ¼ï¼ˆä¸åŒ…æ‹¬è´¹ç”¨ï¼‰ï¼Œå°†å…¶ä¹˜ä»¥è‡ªä¸Šæ¬¡äº¤æ¢ä»¥æ¥ç»è¿‡çš„ç§’æ•°ï¼Œå¹¶å°†è¯¥æ•°å­—æ·»åŠ åˆ°ä¹‹å‰çš„ä»·æ ¼ä¸Šã€‚2.è¾¹é™…ä»·æ ¼ â€”â€” è¿™åªæ˜¯ä¸¤ä¸ªå‚¨å¤‡çš„å…³ç³» `price0 = reserve1 / reserve0, price1 = reserve0 / reserve1`

Qï¼šUniswap V2ä¸­å¦‚ä½•å®ç°é¢„è¨€æœºæ—¶ä¸ºä»€ä¹ˆä½¿ç”¨è¾¹é™…ä»·æ ¼ï¼Ÿ  
Aï¼šå¯¹äºä»·æ ¼é¢„è¨€æœºåŠŸèƒ½ï¼ŒUniswap V2ä½¿ç”¨è¾¹é™…ä»·æ ¼ï¼Œè¿™äº›ä»·æ ¼ä¸åŒ…æ‹¬æ»‘ç‚¹å’Œäº¤æ¢è´¹ç”¨ï¼Œä¹Ÿä¸ä¾èµ–äºäº¤æ¢æ•°é‡ã€‚

Qï¼šUniswap V2ä¸ºä»€ä¹ˆä½¿ç”¨ `UQ112.112` è®¡ç®—è¾¹é™…ä»·æ ¼ï¼Ÿ  
Aï¼šSolidityä¸æ”¯æŒæµ®ç‚¹æ•°é™¤æ³•ï¼Œè®¡ç®—è¿™æ ·çš„ä»·æ ¼å¯èƒ½ä¼šå¾ˆæ£˜æ‰‹ï¼šä¾‹å¦‚ï¼Œå¦‚æœä¸¤ä¸ªå‚¨å¤‡çš„æ¯”ç‡ä¸º 2/3 ï¼Œé‚£ä¹ˆä»·æ ¼å°±æ˜¯0ã€‚åœ¨è®¡ç®—è¾¹é™…ä»·æ ¼æ—¶ï¼Œæˆ‘ä»¬éœ€è¦å¢åŠ ç²¾åº¦ï¼Œè€ŒUniswap V2ä½¿ç”¨UQ112.112æ•°å­—æ¥å®ç°è¿™ä¸€ç‚¹ã€‚UQ112.112åŸºæœ¬ä¸Šæ˜¯ä¸€ä¸ªæ•°å­—ï¼Œå…¶ä¸­112ä½ç”¨äºå°æ•°éƒ¨åˆ†ï¼Œ112ä½ç”¨äºæ•´æ•°éƒ¨åˆ†ã€‚

Qï¼šä¸ºä»€ä¹ˆé€‰æ‹©112ä½è¿›è¡Œè¿ç®—ï¼Ÿï¼ˆä¸ºä»€ä¹ˆå˜é‡ä½¿ç”¨ç±»å‹ uint112 ï¼‰
Aï¼šæ°”ä½“ä¼˜åŒ–ã€‚æ¯ä¸ªEVMæ“ä½œéƒ½ä¼šæ¶ˆè€—ä¸€å®šæ•°é‡çš„gasã€‚ç®€å•çš„æ“ä½œï¼Œæ¯”å¦‚ç®—æœ¯è¿ç®—ï¼Œæ¶ˆè€—çš„gaså¾ˆå°‘ï¼Œä½†æœ‰äº›æ“ä½œæ¶ˆè€—çš„gaså¾ˆå¤šã€‚å…¶ä¸­æœ€æ˜‚è´µçš„æ“ä½œæ˜¯ SSTORE -å°†å€¼ä¿å­˜åˆ°åˆçº¦å­˜å‚¨ä¸­ã€‚å®ƒçš„å¯¹åº”æ“ä½œ SLOAD ä¹Ÿå¾ˆæ˜‚è´µã€‚å› æ­¤ï¼Œå¦‚æœæ™ºèƒ½åˆçº¦å¼€å‘è€…å°è¯•ä¼˜åŒ–å…¶åˆçº¦çš„gasæ¶ˆè€—ï¼Œå¯¹ç”¨æˆ·æ¥è¯´æ˜¯æœ‰ç›Šçš„ã€‚ä½¿ç”¨ uint112 æ¥ä¿ç•™å˜é‡æ­£æ˜¯ä¸ºäº†è¾¾åˆ°è¿™ä¸ªç›®çš„ã€‚

Qï¼šä¸ºä»€ä¹ˆåœ¨ä»·æ ¼è®¡ç®—ä¹‹å‰å®ƒä»¬è¢«ä¹˜ä»¥ 2**112 ï¼Ÿ  
Aï¼š`price0CumulativeLast += uint256(UQ112x112.encode(reserve1_).uqdiv(reserve0_)) * timeElapsed` ï¼Œå‚¨å¤‡ä»¥UQ112.112æ•°å­—çš„æ•´æ•°éƒ¨åˆ†å½¢å¼å­˜å‚¨ã€‚UQ112x112.encode å°† uint112 å€¼ä¹˜ä»¥ 2**112 ï¼Œä½¿å…¶æˆä¸º uint224 å€¼ã€‚ç„¶åï¼Œå®ƒè¢«å¦ä¸€ä¸ªå‚¨å¤‡é™¤ä»¥å¹¶ä¹˜ä»¥ timeElapsed ã€‚ç»“æœè¢«åŠ åˆ°å½“å‰å­˜å‚¨çš„å€¼ä¸Šï¼Œè¿™ä½¿å…¶ç´¯ç§¯ã€‚
GPTï¼šä¸¾ä¾‹å­å¸®åŠ©ç†è§£

Qï¼šè®¡ç®—è¾¹é™…ä»·æ ¼æ—¶ï¼Œä¸ºä»€ä¹ˆä½¿ç”¨ unchecked å—ï¼Ÿ  
Aï¼šåœ¨è®¡ç®— timeElapsed å’Œç´¯ç§¯ä»·æ ¼æ—¶ï¼Œæˆ‘ä»¬ä½¿ç”¨ unchecked å—ã€‚è¿™ä¼¼ä¹å¯¹åˆçº¦çš„å®‰å…¨æ€§ä¸åˆ©ï¼Œä½†æ˜¯é¢„è®¡æ—¶é—´æˆ³å’Œç´¯ç§¯ä»·æ ¼ä¼šæº¢å‡ºï¼šå½“å®ƒä»¬ä¸­çš„ä»»ä½•ä¸€ä¸ªæº¢å‡ºæ—¶ï¼Œä¸ä¼šå‘ç”Ÿä»»ä½•ä¸è‰¯æƒ…å†µã€‚æˆ‘ä»¬å¸Œæœ›å®ƒä»¬åœ¨æº¢å‡ºæ—¶ä¸ä¼šæŠ›å‡ºé”™è¯¯ï¼Œä»¥ä¾¿èƒ½å¤Ÿæ­£å¸¸è¿è¡Œã€‚
GPTï¼šä¸ºä»€ä¹ˆå‘ç”Ÿæº¢å‡ºä¸ä¼šå½±å“åˆçº¦ï¼Ÿ

Qï¼šä¸ºä»€ä¹ˆéœ€è¦ SafeMath åº“ï¼Ÿ  
Aï¼šç›´åˆ°ç‰ˆæœ¬0.8.0ä¹‹å‰ï¼ŒSolidityæ²¡æœ‰æ£€æŸ¥æº¢å‡ºå’Œä¸‹æº¢ï¼Œäºæ˜¯å¼€å‘è€…ä»¬æƒ³å‡ºäº†ä¸€ä¸ªåº“ï¼šSafeMathã€‚å¦‚ä»Šï¼Œç”±äºSolidityç°åœ¨åœ¨æ£€æµ‹åˆ°æº¢å‡ºæˆ–ä¸‹æº¢æ—¶ä¼šæŠ›å‡ºå¼‚å¸¸ï¼Œæ‰€ä»¥è¿™ä¸ªåº“å·²ç»ä¸å†éœ€è¦äº†ã€‚Solidity 0.8.0è¿˜å¼•å…¥äº† unchecked å—ï¼Œé¡¾åæ€ä¹‰ï¼Œå®ƒåœ¨å…¶èŒƒå›´å†…ç¦ç”¨äº†æº¢å‡º/ä¸‹æº¢æ£€æµ‹ã€‚

### Section 3

Qï¼šä¸ºä»€ä¹ˆéœ€è¦å·¥å‚åˆçº¦ï¼Ÿ  
Aï¼š1.å·¥å‚åˆçº¦æ˜¯æ‰€æœ‰å·²éƒ¨ç½²çš„é…å¯¹åˆçº¦çš„æ³¨å†Œè¡¨ã€‚è¿™ä¸ªåˆçº¦æ˜¯å¿…è¦çš„ï¼Œå› ä¸ºæˆ‘ä»¬**ä¸å¸Œæœ›æœ‰ç›¸åŒä»£å¸çš„é…å¯¹ï¼Œä»¥å…æµåŠ¨æ€§åˆ†æ•£åˆ°å¤šä¸ªç›¸åŒçš„é…å¯¹ä¸­**ã€‚è¯¥åˆçº¦è¿˜ç®€åŒ–äº†é…å¯¹åˆçº¦çš„éƒ¨ç½²è¿‡ç¨‹ï¼šä¸éœ€è¦æ‰‹åŠ¨éƒ¨ç½²é…å¯¹åˆçº¦ï¼Œåªéœ€åœ¨å·¥å‚åˆçº¦ä¸­è°ƒç”¨ä¸€ä¸ªæ–¹æ³•å³å¯ã€‚2.Uniswapå›¢é˜Ÿåªéƒ¨ç½²äº†ä¸€ä¸ªå·¥å‚åˆçº¦ï¼Œè¯¥åˆçº¦ä½œä¸ºUniswapäº¤æ˜“å¯¹çš„å®˜æ–¹æ³¨å†Œè¡¨ã€‚è¿™åœ¨äº¤æ˜“å¯¹çš„å‘ç°æ–¹é¢ä¹Ÿéå¸¸æœ‰ç”¨ï¼šæˆ‘ä»¬å¯ä»¥æŸ¥è¯¢åˆçº¦ä»¥é€šè¿‡ä»£å¸åœ°å€æ‰¾åˆ°ä¸€ä¸ªäº¤æ˜“å¯¹ã€‚æ­¤å¤–ï¼Œå¯ä»¥æ‰«æåˆçº¦äº‹ä»¶çš„å†å²è®°å½•ä»¥æ‰¾åˆ°æ‰€æœ‰éƒ¨ç½²çš„äº¤æ˜“å¯¹ã€‚å½“ç„¶ï¼Œæˆ‘ä»¬ä¹Ÿå¯ä»¥æ‰‹åŠ¨éƒ¨ç½²æˆ‘ä»¬çš„äº¤æ˜“å¯¹ï¼Œè€Œä¸å°†å…¶æ³¨å†Œåˆ°å·¥å‚åˆçº¦ä¸­ã€‚

Qï¼šUniswapV2 ä¸­ Router åˆçº¦çš„ä½œç”¨æ˜¯ä»€ä¹ˆï¼Ÿ  
Aï¼šRouter åˆçº¦æ˜¯ä¸€ä¸ªé«˜çº§åˆçº¦ï¼Œå®ƒä½œä¸ºå¤§å¤šæ•°ç”¨æˆ·åº”ç”¨ç¨‹åºçš„å…¥å£ã€‚è¯¥åˆçº¦ä½¿åˆ›å»ºäº¤æ˜“å¯¹ã€æ·»åŠ å’Œç§»é™¤æµåŠ¨æ€§ã€è®¡ç®—æ‰€æœ‰å¯èƒ½çš„äº¤æ¢å˜åŒ–çš„ä»·æ ¼ä»¥åŠæ‰§è¡Œå®é™…äº¤æ˜“å˜å¾—æ›´åŠ ç®€å•ã€‚ Router ä¸é€šè¿‡å·¥å‚åˆçº¦éƒ¨ç½²çš„æ‰€æœ‰äº¤æ˜“å¯¹ä¸€èµ·å·¥ä½œï¼Œå®ƒæ˜¯ä¸€ä¸ªé€šç”¨åˆçº¦ã€‚

Qï¼šUniswapV2 ä¸­ Library åˆçº¦çš„ä½œç”¨æ˜¯ä»€ä¹ˆï¼Ÿ  
Aï¼šè¯¥åˆçº¦å®ç°äº†æ‰€æœ‰åŸºæœ¬å’Œæ ¸å¿ƒåŠŸèƒ½ï¼Œå…¶ä¸­å¤§éƒ¨åˆ†æ˜¯äº¤æ¢é‡‘é¢çš„è®¡ç®—ã€‚

Qï¼šUniswapV2 ä¸­ Router åˆçº¦çš„ addLiquidity ä¸­çš„å„ä¸ªå‚æ•°åˆ†åˆ«ä»€ä¹ˆä½œç”¨ï¼Ÿ  
Aï¼š1.ä½¿ç”¨ tokenA å’Œ tokenB æ¥æŸ¥æ‰¾ï¼ˆæˆ–åˆ›å»ºï¼‰æˆ‘ä»¬æƒ³è¦å¢åŠ æµåŠ¨æ€§çš„äº¤æ˜“å¯¹ã€‚2.amountADesired å’Œ amountBDesired æ˜¯æˆ‘ä»¬æƒ³è¦å­˜å…¥è¯¥å¯¹çš„é‡‘é¢ã€‚è¿™äº›æ˜¯ä¸Šé™ã€‚3.amountAMin å’Œ amountBMin æ˜¯æˆ‘ä»¬å¸Œæœ›å­˜å…¥çš„æœ€ä½é‡‘é¢ã€‚è®°ä½ï¼Œå½“æˆ‘ä»¬å­˜å…¥ä¸å¹³è¡¡çš„æµåŠ¨æ€§æ—¶ï¼Œ Pair åˆçº¦æ€»æ˜¯å‘è¡Œè¾ƒå°‘çš„LPä»£å¸ï¼ˆæˆ‘ä»¬åœ¨ç¬¬ä¸€éƒ¨åˆ†ä¸­è®¨è®ºè¿‡è¿™ä¸ªé—®é¢˜ï¼‰ã€‚å› æ­¤ï¼Œ min å‚æ•°å…è®¸æˆ‘ä»¬æ§åˆ¶æˆ‘ä»¬æ„¿æ„æŸå¤±å¤šå°‘æµåŠ¨æ€§ã€‚4.to åœ°å€æ˜¯æ¥æ”¶LPä»£å¸çš„åœ°å€ã€‚
```solidity
function addLiquidity(
    address tokenA,
    address tokenB,
    uint256 amountADesired,
    uint256 amountBDesired,
    uint256 amountAMin,
    uint256 amountBMin,
    address to
) public returns (uint256 amountA, uint256 amountB, uint256 liquidity) {}
```

Qï¼šSoldity ä¸­ Library åˆçº¦å’Œå¸¸è§åˆçº¦ä»€ä¹ˆåŒºåˆ«ï¼Ÿ  
Aï¼šåœ¨Solidityä¸­ï¼ŒLibraryæ˜¯ä¸€ä¸ªæ— çŠ¶æ€åˆçº¦ï¼ˆå³å®ƒæ²¡æœ‰å¯å˜çŠ¶æ€ï¼‰ï¼Œå®ƒå®ç°äº†ä¸€ç»„å¯ä»¥è¢«å…¶ä»–åˆçº¦ä½¿ç”¨çš„å‡½æ•°ï¼Œè¿™æ˜¯Libraryçš„ä¸»è¦ç›®çš„ã€‚ä¸åˆçº¦ä¸åŒï¼ŒLibraryæ²¡æœ‰çŠ¶æ€ï¼šå®ƒä»¬çš„å‡½æ•°é€šè¿‡DELEGATECALLåœ¨è°ƒç”¨è€…çš„çŠ¶æ€ä¸‹æ‰§è¡Œã€‚ä½†æ˜¯ï¼Œä¸åˆçº¦ä¸€æ ·ï¼ŒLibraryå¿…é¡»éƒ¨ç½²æ‰èƒ½ä½¿ç”¨ã€‚å¹¸è¿çš„æ˜¯ï¼ŒForgeä½¿æˆ‘ä»¬çš„ç”Ÿæ´»æ›´è½»æ¾ï¼Œå› ä¸ºå®ƒæ”¯æŒè‡ªåŠ¨é“¾æ¥Libraryï¼ˆæˆ‘ä»¬ä¸éœ€è¦åœ¨æµ‹è¯•ä¸­éƒ¨ç½²Libraryï¼‰ã€‚

Qï¼šUniswapV2Library å’Œ UniswapV2Pair ä¸­çš„ getReserve æœ‰ä»€ä¹ˆåŒºåˆ«ï¼Ÿ  
Aï¼šUniswapV2Library æ˜¯ä¸€ä¸ªé«˜çº§åŠŸèƒ½ï¼Œå®ƒå¯ä»¥è·å–ä»»ä½•äº¤æ˜“å¯¹çš„å‚¨å¤‡é‡‘ï¼ˆä¸è¦å°†å…¶ä¸äº¤æ˜“å¯¹åˆçº¦ä¸­çš„é‚£ä¸ªæ··æ·†ï¼Œåè€…è¿”å›ç‰¹å®šäº¤æ˜“å¯¹çš„å‚¨å¤‡é‡‘ï¼‰ã€‚

Qï¼šUniswapV2Library ä¸­ pairFor å¦‚ä½•å¾—åˆ° pair çš„åœ°å€ï¼Ÿ  
Aï¼šEIP-1014 ã€‚åœ°å€è®¡ç®—ï¼š`keccak256( 0xff ++ address ++ salt ++ keccak256(init_code))[12:]` ã€‚

Qï¼šSolidity ä¸­ `import {UniswapV2Pair} from "./UniswapV2Pair.sol"` å’Œ `import "./UniswapV2Pair.sol` æœ‰ä»€ä¹ˆåŒºåˆ«ï¼Ÿ  
Aï¼š1.`import {UniswapV2Pair} from "./UniswapV2Pair.sol"`ï¼šè¿™ä¸ªè¯­å¥å¯¼å…¥UniswapV2Pair.solæ–‡ä»¶ä¸­çš„UniswapV2Pairåˆçº¦ã€‚ä½¿ç”¨è¿™ç§æ–¹å¼ï¼Œåªèƒ½è®¿é—®åˆ°UniswapV2Pairè¿™ä¸ªåˆçº¦ï¼Œå…¶ä»–åœ¨UniswapV2Pair.solæ–‡ä»¶ä¸­å®šä¹‰çš„åˆçº¦æˆ–è€…åº“å°†ä¸èƒ½è®¿é—®ã€‚è¿™ç§æ–¹å¼å¸¸å¸¸ç”¨äºåªéœ€è¦æ–‡ä»¶ä¸­éƒ¨åˆ†åˆçº¦æˆ–è€…åº“çš„åœºæ™¯ï¼Œé¿å…å…¨å±€æ±¡æŸ“ã€‚2.`import "./UniswapV2Pair.sol`ï¼šè¿™ä¸ªè¯­å¥å¯¼å…¥UniswapV2Pair.solæ–‡ä»¶çš„æ‰€æœ‰å†…å®¹ã€‚ä½¿ç”¨è¿™ç§æ–¹å¼ï¼ŒUniswapV2Pair.solæ–‡ä»¶ä¸­å®šä¹‰çš„æ‰€æœ‰åˆçº¦æˆ–è€…åº“éƒ½å¯ä»¥è®¿é—®ã€‚è¿™ç§æ–¹å¼é€‚ç”¨äºéœ€è¦æ–‡ä»¶ä¸­å…¨éƒ¨åˆçº¦æˆ–è€…åº“çš„åœºæ™¯ã€‚ï¼ˆä½¿ç”¨`import "./UniswapV2Pair.sol"`ï¼Œä¼šå‡ºç°å¼‚å¸¸ï¼š`error InsufficientLiquidity();` ï¼ŒIdentifier already declared.ï¼‰

### Section 4

Qï¼š`swapExactTokensForTokens` å’Œ `swapTokensForExactTokens` æœ‰ä»€ä¹ˆåŒºåˆ«ï¼Ÿ  
Aï¼š`swapExactTokensForTokens` å½“æˆ‘ä»¬æ‹¥æœ‰ç¡®å®šæ•°é‡çš„ä»£å¸ï¼Œå¹¶å¸Œæœ›ä»¥è®¡ç®—å‡ºçš„æ•°é‡è¿›è¡Œäº¤æ¢ï¼ˆè¾“å…¥å·²çŸ¥ï¼Œè¾“å‡ºæœªçŸ¥ï¼‰ã€‚ `swapTokensForExactTokens` åå‘äº¤æ¢ï¼Œå°†æœªçŸ¥æ•°é‡çš„è¾“å…¥ä»£å¸äº¤æ¢ä¸ºç²¾ç¡®æ•°é‡çš„è¾“å‡ºä»£å¸ã€‚

Qï¼šåœ¨ä½¿ç”¨ `Î”x= (yâˆ’Î”y)r / xÎ”y` â€‹è®¡ç®—ç»“æœåï¼Œä¸ºä»€ä¹ˆéœ€è¦åŠ ä¸Š 1 ï¼Ÿ  
```solidity
    function getAmountIn(
        uint256 amountOut,
        uint256 reserveIn,
        uint256 reserveOut
    ) public view returns (uint256) {
        if (amountOut == 0) {
            revert InsufficientAmount();
        }
        if (reserveIn == 0 || reserveOut == 0) {
            revert InsufficientLiquidity();
        }

        uint256 numerator = reserveIn * amountOut * 1000;
        uint256 denominator = (reserveOut - amountOut) * 997;

        return (numerator / denominator) + 1;
    }
```
Aï¼šåœ¨Solidityä¸­ï¼Œé™¤æ³•æ˜¯æ•´æ•°é™¤æ³•ï¼Œç»“æœä¼šå‘ä¸‹å–æ•´ï¼Œä¹Ÿå°±æ˜¯è¯´ç»“æœä¼šè¢«æˆªæ–­ã€‚åœ¨è¾“å…¥é‡‘é¢è®¡ç®—ä¸­ï¼Œæˆ‘ä»¬å¸Œæœ›ç¡®ä¿è®¡ç®—å‡ºçš„é‡‘é¢èƒ½å¤Ÿå¾—åˆ°æ‰€éœ€çš„ amountOut ã€‚å¦‚æœç»“æœè¢«æˆªæ–­ï¼Œè¾“å‡ºé‡‘é¢å°†ä¼šç¨å¾®åå°ã€‚

Qï¼šä¸‹é¢è¿™éƒ¨åˆ†åœ¨ UniswapV2Pair çš„ `swap(uint256 amount0Out, uint256 amount1Out, address to)` ä¸­çš„ä»£ç å¦‚ä½•ç†è§£ï¼Ÿ
```solidity
uint256 amount0In = balance0 > reserve0_ - amount0Out ? balance0 - (reserve0_ - amount0Out) : 0;
uint256 amount1In = balance1 > reserve1_ - amount1Out ? balance1 - (reserve1_ - amount1Out) : 0;
```
Aï¼šè¿™ä¸¤è¡Œä»£ç çš„ç›®çš„æ˜¯è®¡ç®—ç”¨æˆ·ä¸ºäº†å¾—åˆ°amount0Outå’Œamount1Outï¼Œéœ€è¦æä¾›å¤šå°‘çš„amount0Inå’Œamount1Inã€‚æ¯ç§tokençš„å‡†å¤‡é‡‘ä½™é¢ï¼ˆå³reserve0_å’Œreserve1_ï¼‰ï¼Œbalance0å’Œbalance1è¡¨ç¤ºäº¤æ˜“ååˆçº¦ä¸­æ¯ç§tokençš„ä½™é¢ã€‚amount0Outå’Œamount1Outæ˜¯ç”¨æˆ·å¸Œæœ›ä»äº¤æ˜“ä¸­å¾—åˆ°çš„token0å’Œtoken1çš„æ•°é‡ã€‚balance0 > reserve0_ - amount0Outå’Œbalance1 > reserve1_ - amount1Outçš„åˆ¤æ–­è¯­å¥æ˜¯æ£€æŸ¥äº¤æ˜“ååˆçº¦çš„ä½™é¢æ˜¯å¦è¶…è¿‡äº†äº¤æ˜“å‰çš„å‡†å¤‡é‡‘ä½™é¢å‡å»è¾“å‡ºé‡ï¼Œå¦‚æœè¶…è¿‡äº†ï¼Œé‚£ä¹ˆè¾“å…¥é‡å°±ç­‰äºäº¤æ˜“åçš„ä½™é¢å‡å»ï¼ˆäº¤æ˜“å‰çš„å‡†å¤‡é‡‘ä½™é¢å‡å»è¾“å‡ºé‡ï¼‰ï¼›å¦åˆ™ï¼Œè¾“å…¥é‡ä¸º0ã€‚ï¼ˆå‡è®¾äº¤æ˜“å‰ï¼Œtoken0å’Œtoken1çš„å‚¨å¤‡åˆ†åˆ«ä¸º1000ã€‚ç„¶åï¼Œä¸€ä¸ªç”¨æˆ·å¸Œæœ›é€šè¿‡äº¤æ˜“è·å¾—100ä¸ªtoken0ï¼ˆå³amount0Outä¸º100ï¼‰ï¼Œå¹¶æ„¿æ„æä¾›ä¸€å®šæ•°é‡çš„token1ä½œä¸ºäº¤æ¢ã€‚é‚£ä¹ˆåœ¨äº¤æ˜“åï¼Œåˆçº¦ä¸­token0çš„å‚¨å¤‡å°†å‡å°‘åˆ°900ï¼Œå¦‚æœæ­¤æ—¶token0çš„ä½™é¢ï¼ˆbalance0ï¼‰ä¸º910ï¼Œé‚£ä¹ˆç”¨æˆ·å®é™…æä¾›çš„token0çš„æ•°é‡ï¼ˆå³amount0Inï¼‰å°±ä¸º910 - (1000 - 100) = 10ã€‚ï¼‰

Qï¼šä¸ºä»€ä¹ˆ_update(balance0, balance1, reserve0_, reserve1_); æ›´æ–°å‚¨å¤‡çš„æ—¶å€™ï¼Œä¸ä½¿ç”¨balance0Adjustedå’Œbalance1Adjustedï¼Œæ­¤æ¬¡æ˜¯bugå—ï¼Ÿ
```solidity
uint256 balance0Adjusted = (balance0 * 1000) - (amount0In * 3);
uint256 balance1Adjusted = (balance1 * 1000) - (amount1In * 3);

if (balance0Adjusted * balance1Adjusted < uint256(reserve0_) * uint256(reserve1_) * 1000**2) revert InvalidK();
    
_update(balance0, balance1, reserve0_, reserve1_);
```
Aï¼šè¿™å¹¶ä¸æ˜¯ä¸€ä¸ª bugã€‚1.åœ¨ Uniswap ä¸­ï¼Œæ¯ä¸€æ¬¡äº¤æ˜“éƒ½ä¼šå¯¼è‡´ä¸¤ç§ä»£å¸çš„å‚¨å¤‡é‡ï¼ˆreservesï¼‰å‘ç”Ÿå˜åŒ–ã€‚è¿™äº›å‚¨å¤‡é‡çš„ä¹˜ç§¯ï¼Œä¹Ÿå°±æ˜¯æ‰€è°“çš„ K å€¼ï¼Œåœ¨äº¤æ˜“å‰ååº”è¯¥ä¿æŒæ’å®šï¼Œè¿™å°±æ˜¯ Uniswap çš„â€œæ’å®šäº§å“å…¬å¼â€ï¼ˆConstant Product Formulaï¼‰ã€‚2.balance0Adjusted å’Œ balance1Adjusted æ˜¯ç”¨äºæ£€æŸ¥äº¤æ˜“æ˜¯å¦ç¬¦åˆæ»‘ç‚¹è¦æ±‚çš„ï¼Œå®ƒä»¬å¹¶ä¸ä»£è¡¨äº¤æ˜“å®Œæˆåçš„å®é™…å‚¨å¤‡é‡ã€‚å®é™…çš„å‚¨å¤‡é‡åº”è¯¥æ˜¯äº¤æ˜“å®Œæˆåçš„ä½™é¢ï¼Œå³ balance0 å’Œ balance1ã€‚3.åœ¨è°ƒç”¨ _update å‡½æ•°æ›´æ–°å‚¨å¤‡é‡æ—¶ï¼Œåº”è¯¥ä½¿ç”¨ balance0 å’Œ balance1 è€Œä¸æ˜¯ balance0Adjusted å’Œ balance1Adjustedã€‚è¿™æ ·æ‰èƒ½ä¿è¯å‚¨å¤‡é‡çš„æ›´æ–°åæ˜ äº†äº¤æ˜“åçš„å®é™…çŠ¶æ€ã€‚4.æ»‘ç‚¹è°ƒæ•´çš„ balance0Adjusted å’Œ balance1Adjusted åªæ˜¯ç”¨äºåœ¨äº¤æ˜“å‰æ£€æŸ¥äº¤æ˜“æ˜¯å¦ä¼šå¯¼è‡´ä»·æ ¼å˜åŠ¨è¶…è¿‡å…è®¸çš„æ»‘ç‚¹ã€‚å¦‚æœæ»‘ç‚¹è¿‡å¤§ï¼Œè¯¥äº¤æ˜“ä¼šè¢«æ‹’ç»ï¼Œä»¥é˜²æ­¢æ¶æ„ç”¨æˆ·é€šè¿‡å¤§é‡äº¤æ˜“æ“çºµä»·æ ¼ã€‚è¿™æ˜¯ Uniswap çš„ä¸€ç§ä¿æŠ¤æœºåˆ¶ï¼Œä½†å¹¶ä¸å½±å“å®é™…çš„å‚¨å¤‡é‡æ›´æ–°ã€‚

Qï¼šä¸ºä»€ä¹ˆ `if (data.length > 0) IUniswapV2Callee(to).uniswapV2Call(msg.sender, amount0Out, amount1Out, data)` å®ç°äº†é—ªç”µè´·åŠŸèƒ½ï¼Ÿ  
Aï¼šè¿™è¡Œä»£ç ä½äºå€Ÿæ¬¾å’Œæ£€æŸ¥è¿˜æ¬¾ä¹‹é—´ï¼Œå€ŸåŠ©äº†åŒºå—é“¾äº¤æ˜“çš„åŸå­æ€§ï¼Œå®ç°äº†é—ªç”µè´·åŠŸèƒ½ã€‚å…ˆç»™ç”¨æˆ·æ‰“æ¬¾ï¼Œæ¥ç€è°ƒç”¨ IUniswapV2Callee æ¥å£çš„ uniswapV2Call å‡½æ•°ï¼Œè¿™ä¸ªå‡½æ•°æ˜¯ç”±ç”¨æˆ·è‡ªå·±å®ç°çš„ï¼Œç”¨æˆ·å¯ä»¥åœ¨è¿™ä¸ªå‡½æ•°ä¸­æ‰§è¡Œä»»æ„æ“ä½œï¼ŒåŒ…æ‹¬è¿˜æ¬¾ã€‚uniswapV2Call ä¸åœ¨æ„ç”¨æˆ·å€Ÿæ¬¾ä¹‹åçš„æ“ä½œï¼Œåªéœ€è¦ç”¨æˆ·åœ¨ uniswapV2Call ä¸­å®ç°è¿˜æ¬¾æ“ä½œï¼Œè¿˜æ¬¾é‡‘é¢èƒ½å¤Ÿé€šè¿‡ä¸‹æ–¹çš„æ¡ä»¶æ£€æŸ¥å³å¯ã€‚å¦‚æœè¿˜æ¬¾é‡‘é¢ä¸æ»¡è¶³è¦æ±‚ï¼Œäº¤æ˜“ä¼šè¢«å›æ»šï¼Œç”¨æˆ·çš„å€Ÿæ¬¾ä¹Ÿä¸ä¼šè¢«æ‰§è¡Œã€‚ 
```solidity
if (amount0Out > 0) _safeTransfer(token0, to, amount0Out);
if (amount1Out > 0) _safeTransfer(token1, to, amount1Out);
if (data.length > 0) IUniswapV2Callee(to).uniswapV2Call(msg.sender, amount0Out, amount1Out, data);

uint256 balance0 = IERC20(token0).balanceOf(address(this));
uint256 balance1 = IERC20(token1).balanceOf(address(this));     
```